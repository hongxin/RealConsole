# 系统操作安全性分析

**日期**: 2025-10-15
**目的**: 评估 50 个使用场景中的安全风险，确定哪些操作可以安全支持

---

## 安全风险分类

### 🔴 高危操作 - 暂缓支持

这些操作可能造成**不可逆损害**或**严重安全问题**，暂缓支持：

#### 1. 文件删除 (rm -rf)
**风险**:
- 误删重要文件/系统文件
- `rm -rf /` 类型的灾难性错误
- 无法恢复

**场景**: #5 删除文件或目录

**建议**:
- ⏸️ **暂缓支持** - 风险太高
- 如需支持，必须实施：
  - 严格路径白名单
  - 多次确认机制
  - 预览将被删除的文件列表
  - 禁止删除系统目录

#### 2. 用户管理 (useradd, passwd, userdel)
**风险**:
- 需要 root 权限
- 可能破坏系统用户配置
- 安全隐患

**场景**: #32-34 切换用户、创建用户、修改密码

**建议**:
- ⏸️ **暂缓支持** - 需要 root 权限，风险高
- 企业环境不应通过 AI 管理用户

#### 3. 磁盘分区管理 (fdisk, parted)
**风险**:
- 可能导致数据丢失
- 破坏文件系统
- 需要 root 权限

**场景**: #47 管理磁盘分区

**建议**:
- ⏸️ **暂缓支持** - 极高风险，专业运维操作

#### 4. 文件系统挂载 (mount, umount)
**风险**:
- 不当挂载可能导致数据损坏
- 需要 root 权限
- 误卸载可能导致系统不可用

**场景**: #48 挂载/卸载文件系统

**建议**:
- ⏸️ **暂缓支持** - 需要 root 权限，专业操作

---

### 🟡 中危操作 - 需要安全增强

这些操作有风险，但可以通过**确认机制**和**参数验证**安全支持：

#### 1. 文件移动/重命名 (mv)
**风险**:
- 覆盖重要文件
- 移动系统文件

**场景**: #7 移动或重命名文件

**安全措施**:
- ✅ 可以支持，但需：
  - 目标存在时提示确认
  - 禁止移动到系统目录
  - 路径验证

#### 2. 文件复制 (cp)
**风险**:
- 覆盖目标文件
- 大文件复制耗尽磁盘空间

**场景**: #6 复制文件到指定位置

**安全措施**:
- ✅ 可以支持，但需：
  - 目标存在时提示
  - 检查磁盘空间
  - 大文件警告

#### 3. 修改文件权限 (chmod)
**风险**:
- 错误权限可能导致安全漏洞
- 过度权限 (777) 很危险

**场景**: #13 修改文件权限

**安全措施**:
- ✅ 可以支持，但需：
  - 禁止 777 等危险权限
  - 仅允许用户自己的文件
  - 提示权限变更的含义

#### 4. 终止进程 (kill)
**风险**:
- 终止关键系统进程
- 数据丢失

**场景**: #18 终止指定进程

**安全措施**:
- ✅ 可以支持，但需：
  - 仅允许终止用户自己的进程
  - 系统进程黑名单
  - 提示确认

#### 5. 服务管理 (systemctl, launchctl)
**风险**:
- 停止关键服务影响系统
- 可能需要 sudo

**场景**: #22-23 查看/启动/停止服务

**安全措施**:
- 🟡 **查看服务状态**: ✅ 安全，可以支持
- 🔴 **启动/停止服务**: ⏸️ 暂缓，需要 sudo

#### 6. 软件包管理 (apt, brew install)
**风险**:
- 安装恶意软件
- 需要 sudo 权限
- 可能破坏系统依赖

**场景**: #24-27 安装/更新/升级/卸载软件

**安全措施**:
- 🟡 **查询软件包**: ✅ 安全
- 🔴 **安装/卸载**: ⏸️ 暂缓，需要 sudo 和用户明确意图

---

### 🟢 低危操作 - 可以安全支持

这些操作**只读**或**影响有限**，可以安全支持：

#### 1. 文件查看类 (cat, less, head, tail)
**风险**: 几乎无风险
**场景**: #8 查看文件内容
**状态**: ✅ 已支持 (read_file)

#### 2. 文件查找类 (find, locate)
**风险**: 几乎无风险
**场景**: #11 查找文件
**状态**: ✅ 部分支持，可以增强

#### 3. 目录创建 (mkdir)
**风险**: 低，仅占用少量磁盘空间
**场景**: #4 创建新目录
**安全措施**:
- ✅ 可以支持
- 路径验证，避免系统目录
- 检查磁盘空间

#### 4. 系统信息查询 (top, ps, df, free, uname)
**风险**: 无，只读操作
**场景**: #15-17, #28-31 系统监控
**状态**: ✅ 大部分已支持

#### 5. 网络测试 (ping, traceroute)
**风险**: 低，可能泄露网络拓扑
**场景**: #20 测试网络连通性
**安全措施**:
- ✅ 可以支持
- 限制 ping 次数 (-c 4)

#### 6. 文件搜索 (grep)
**风险**: 低，只读
**场景**: #10 搜索字符串
**状态**: ✅ 已支持

#### 7. 文件统计 (wc)
**风险**: 无，只读
**场景**: #42 统计行数/字数
**状态**: 🟡 部分支持，可以增强

#### 8. 压缩/解压 (tar, zip)
**风险**:
- 压缩：低
- 解压：中（可能覆盖文件）

**场景**: #35-36 压缩/解压缩
**安全措施**:
- ✅ **压缩**: 可以支持
- 🟡 **解压**: 需要确认覆盖

#### 9. 文件比较 (diff)
**风险**: 无，只读
**场景**: #41 比较文件差异
**状态**: ✅ 可以支持

#### 10. 环境变量 (echo $VAR, env)
**风险**:
- 查看：无
- 设置：低（仅影响当前会话）

**场景**: #38-39 查看/设置环境变量
**状态**:
- 查看：✅ 可以支持
- 设置：🟡 需要说明仅影响当前会话

#### 11. 符号链接 (ln -s)
**风险**: 低，但可能造成混淆
**场景**: #40 创建符号链接
**安全措施**:
- ✅ 可以支持
- 验证源文件存在
- 目标路径验证

#### 12. 后台运行 (nohup, &)
**风险**: 低，但可能占用资源
**场景**: #44 后台运行程序
**安全措施**:
- ✅ 可以支持
- 提示后台进程 PID
- 建议如何查看和终止

#### 13. 定时任务查看 (crontab -l)
**风险**:
- 查看：无
- 编辑：中（可能导致意外任务执行）

**场景**: #45 定时执行任务
**状态**:
- 查看：✅ 可以支持
- 编辑：🟡 需要增强安全措施

---

## 调整后的优先级

### Phase 6.1: 安全优先 - 低危操作 (1周)

**目标**: 仅实现安全的功能，无破坏性操作

#### 文件管理类 (4个)
1. ✅ 创建目录 (mkdir) - 低危
2. ✅ 查找文件增强 (find by name) - 无危
3. ✅ 统计文件信息 (wc) - 无危
4. ✅ 比较文件 (diff) - 无危

#### 系统监控类 (2个)
5. ✅ 测试网络 (ping) - 低危
6. ✅ 查看服务状态 (仅查询) - 无危

#### 系统工具类 (2个)
7. ✅ 查看环境变量 - 无危
8. ✅ 创建符号链接 - 低危

**总计**: 8 个安全场景

### Phase 6.2: 增强安全 - 中危操作 (2周)

**目标**: 实现有风险但可控的功能，加强确认机制

#### 文件管理类 (4个)
1. 🟡 复制文件 (cp) - 需要确认
2. 🟡 移动/重命名 (mv) - 需要确认
3. 🟡 压缩/解压 (tar, zip) - 解压需要确认
4. 🟡 修改权限 (chmod) - 严格验证

#### 系统监控类 (1个)
5. 🟡 终止进程 (kill) - 进程验证 + 确认

#### 系统工具类 (2个)
6. 🟡 后台运行 - 资源监控
7. 🟡 定时任务查看 - 仅查看

**总计**: 7 个中危场景（需要安全增强）

### Phase 6.3: 企业级 - 高危操作 (未来/可选)

⏸️ **暂缓支持**，需要企业级安全框架：

1. 🔴 文件删除 (rm -rf)
2. 🔴 用户管理
3. 🔴 服务启动/停止
4. 🔴 软件安装/卸载
5. 🔴 磁盘分区管理
6. 🔴 文件系统挂载

**前提条件**:
- 审计日志系统
- 操作回滚机制
- 多因素认证
- 权限管理系统

---

## 安全设计原则

### 1. 最小权限原则
- 仅请求必要的权限
- 不主动使用 sudo
- 用户明确授权

### 2. 防御性编程
- 严格参数验证
- 路径规范化
- 防止注入攻击

### 3. 明确确认
- 破坏性操作需要确认
- 显示操作后果
- 提供撤销建议

### 4. 审计追踪
- 记录所有操作到 execution_logger
- 保留操作上下文
- 支持事后审查

### 5. 渐进式增强
- 从只读操作开始
- 逐步增加写操作
- 最后考虑破坏性操作

---

## 具体安全措施

### 文件路径验证
```rust
fn validate_path(path: &str) -> Result<PathBuf, String> {
    let path = PathBuf::from(path);

    // 1. 规范化路径
    let canonical = path.canonicalize()
        .map_err(|_| "路径不存在或无法访问")?;

    // 2. 禁止系统目录
    let forbidden = ["/bin", "/sbin", "/usr/bin", "/System", "/Library"];
    for prefix in &forbidden {
        if canonical.starts_with(prefix) {
            return Err(format!("禁止操作系统目录: {}", prefix));
        }
    }

    // 3. 仅允许用户目录
    let home = std::env::var("HOME").unwrap_or_default();
    if !canonical.starts_with(&home) && !canonical.starts_with("/tmp") {
        return Err("仅允许操作用户目录或 /tmp".to_string());
    }

    Ok(canonical)
}
```

### 确认机制
```rust
fn require_confirmation(operation: &str, target: &str) -> bool {
    println!("⚠️  即将执行: {}", operation);
    println!("   目标: {}", target);
    println!("   确认继续？(yes/no): ");

    let mut input = String::new();
    std::io::stdin().read_line(&mut input).ok();

    input.trim().to_lowercase() == "yes"
}
```

### 进程保护
```rust
fn validate_kill_target(pid: i32) -> Result<(), String> {
    // 1. 检查进程是否存在
    let output = std::process::Command::new("ps")
        .arg("-p")
        .arg(pid.to_string())
        .output()
        .map_err(|_| "无法查询进程")?;

    if !output.status.success() {
        return Err("进程不存在".to_string());
    }

    // 2. 检查进程所有者
    let current_uid = get_current_uid();
    let process_uid = get_process_uid(pid)?;

    if current_uid != process_uid && current_uid != 0 {
        return Err("只能终止自己的进程".to_string());
    }

    // 3. 系统进程黑名单
    let process_name = get_process_name(pid)?;
    let protected = ["init", "systemd", "launchd", "kernel"];

    if protected.contains(&process_name.as_str()) {
        return Err("禁止终止系统关键进程".to_string());
    }

    Ok(())
}
```

---

## 建议的实施顺序

### 第一批 (本周) - 完全安全
1. ✅ find_files_by_name (查找文件)
2. ✅ count_file_stats (统计文件)
3. ✅ compare_files (比较文件)
4. ✅ ping_host (测试网络)
5. ✅ view_env_var (查看环境变量)
6. ✅ check_service_status (查看服务)

### 第二批 (下周) - 低风险写操作
7. ✅ create_directory (创建目录)
8. ✅ create_symlink (符号链接)
9. ✅ compress_files (压缩文件)

### 第三批 (2周后) - 中危操作 + 安全增强
10. 🟡 copy_file (复制文件 + 确认)
11. 🟡 move_file (移动文件 + 确认)
12. 🟡 extract_archive (解压 + 确认)
13. 🟡 change_permission (修改权限 + 验证)
14. 🟡 kill_process (终止进程 + 验证)

### 未来批次 - 需要企业级安全
❌ delete_file (删除文件)
❌ user_management (用户管理)
❌ service_management (服务管理)
❌ package_management (软件管理)

---

## 总结

### 当前决策

**✅ 立即实施** (Phase 6.1): 8-9 个完全安全的场景
**🟡 谨慎实施** (Phase 6.2): 5-7 个中危场景 + 安全增强
**⏸️ 暂缓支持** (Phase 6.3): 6-8 个高危场景

### 覆盖率目标

**Phase 6.1 后**: 36% → **54%** (27/50)
**Phase 6.2 后**: 54% → **68%** (34/50)
**未来**: 保留 16 个高危场景待企业级方案

### 核心价值

通过**安全优先**的策略，我们能够：
1. ✅ 避免灾难性错误
2. ✅ 建立用户信任
3. ✅ 提供实用功能
4. ✅ 保持系统稳定性

**安全 > 功能完整性**

---

**文档版本**: v1.0
**创建日期**: 2025-10-15
**审核状态**: 待确认
