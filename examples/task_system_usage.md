# 任务分解与规划系统使用指南

**Phase 10: Task Decomposition & Planning System**

RealConsole 的任务分解与规划系统能够智能地将复杂任务分解为可执行的子任务序列，自动分析任务依赖关系，生成优化的执行计划（支持并行执行），并提供完整的执行反馈。

---

## 核心功能

### 1. 智能任务分解

使用 LLM 将高层次目标智能分解为具体可执行的子任务：

```bash
/plan <目标描述>
```

系统会自动：
- 分析目标的执行上下文（当前目录、系统类型、Shell等）
- 使用 LLM 生成详细的子任务列表
- 识别任务之间的依赖关系
- 估算每个任务的执行时间

### 2. 依赖分析与规划

系统会自动：
- 构建任务依赖关系图
- 检测循环依赖
- 生成最优执行计划
- 识别可并行执行的任务组

### 3. 任务执行

```bash
/execute
```

执行最近创建的任务计划，支持：
- 串行和并行执行
- 任务超时控制（默认5分钟）
- 错误处理和重试
- 实时进度反馈

### 4. 状态查询

查看当前任务计划：
```bash
/tasks
```

查看执行结果：
```bash
/task_status
```

---

## 使用示例

### 示例 1: 简单文件操作

**目标**: 创建项目结构

```bash
$ /plan 创建一个名为myproject的目录，在里面创建src和tests子目录，并在src中创建main.rs文件

🎯 目标: 创建一个名为myproject的目录，在里面创建src和tests子目录，并在src中创建main.rs文件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 分解任务中...
✓ 已分解为 4 个子任务

📊 生成执行计划...
✓ 执行计划已生成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📈 计划摘要
  总任务数: 4
  执行阶段: 3
  并行阶段: 1
  估计时间: 15秒
  时间节省: 5秒 (效率提升 25.0%)

📋 执行阶段

  阶段 1 串行 (1 任务, ~5秒)
    • 创建项目根目录
      命令: mkdir -p myproject

  阶段 2 并行 (2 任务, ~5秒)
    • 创建src目录 [依赖: task1]
      命令: mkdir -p myproject/src
    • 创建tests目录 [依赖: task1]
      命令: mkdir -p myproject/tests

  阶段 3 串行 (1 任务, ~5秒)
    • 创建main.rs文件 [依赖: task2]
      命令: touch myproject/src/main.rs

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ 使用 /execute 执行任务
```

执行任务：

```bash
$ /execute

🚀 开始执行: 创建一个名为myproject的目录...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

执行中...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 执行结果
  ✓ 全部成功
  总任务: 4
  成功: 4
  总耗时: 12秒
  成功率: 100.0%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 任务执行成功！
```

### 示例 2: 开发工作流

**目标**: 完整的测试和部署流程

```bash
$ /plan 运行项目的单元测试，如果通过则构建生产版本，最后生成测试报告

📋 分解任务中...
✓ 已分解为 3 个子任务

📈 计划摘要
  总任务数: 3
  执行阶段: 3
  并行阶段: 0
  估计时间: 120秒

📋 执行阶段

  阶段 1 串行 (1 任务, ~30秒)
    • 运行单元测试
      命令: cargo test

  阶段 2 串行 (1 任务, ~60秒)
    • 构建生产版本 [依赖: task1]
      命令: cargo build --release

  阶段 3 串行 (1 任务, ~30秒)
    • 生成测试报告 [依赖: task2]
      命令: cargo tarpaulin --out Html
```

### 示例 3: 数据处理流程

**目标**: 批量处理和分析

```bash
$ /plan 下载数据文件，解压，运行数据清洗脚本，然后生成统计图表

📋 分解任务中...
✓ 已分解为 5 个子任务

📈 计划摘要
  总任务数: 5
  执行阶段: 4
  并行阶段: 1
  估计时间: 180秒
  时间节省: 30秒 (效率提升 14.3%)

📋 执行阶段

  阶段 1 串行 (1 任务, ~60秒)
    • 下载数据文件
      命令: wget https://example.com/data.zip

  阶段 2 串行 (1 任务, ~30秒)
    • 解压数据文件 [依赖: task1]
      命令: unzip data.zip -d data/

  阶段 3 并行 (2 任务, ~60秒)
    • 清洗数据集A [依赖: task2]
      命令: python clean_data.py data/dataset_a.csv
    • 清洗数据集B [依赖: task2]
      命令: python clean_data.py data/dataset_b.csv

  阶段 4 串行 (1 任务, ~30秒)
    • 生成统计图表 [依赖: task3, task4]
      命令: python generate_charts.py
```

---

## 命令参考

### /plan

**功能**: 分解和规划任务

**语法**: `/plan <目标描述>`

**示例**:
```bash
/plan 部署应用到生产环境
/plan 分析最近一周的日志文件
/plan 批量转换图片格式
```

**输出**:
- 分解的子任务列表
- 任务依赖关系
- 执行阶段划分
- 时间估算
- 并行优化建议

### /execute

**功能**: 执行当前任务计划

**语法**: `/execute`

**特性**:
- 自动按计划顺序执行
- 支持并行执行
- 超时保护（5分钟）
- 错误处理和重试
- 可跳过失败任务（如果标记为skippable）

**输出**:
- 实时执行进度
- 任务执行结果
- 成功/失败统计
- 详细错误信息

### /tasks

**功能**: 查看当前任务计划

**语法**: `/tasks`

**输出**:
- 计划ID和创建时间
- 所有任务列表
- 执行阶段信息
- 估计执行时间

### /task_status

**功能**: 查看最近的执行结果

**语法**: `/task_status`

**输出**:
- 执行统计（成功/失败/跳过）
- 总耗时
- 每个任务的详细状态
- 失败任务的错误信息

---

## 高级特性

### 1. 任务类型

系统支持多种任务类型：
- **Shell**: 标准Shell命令
- **FileOperation**: 文件操作
- **Network**: 网络请求
- **Validation**: 验证检查
- **UserInput**: 需要用户输入

### 2. 重试策略

任务可以配置重试策略：
- 最大重试次数
- 重试间隔
- 指数退避

### 3. 并行优化

系统自动识别可并行执行的任务：
- 无依赖关系的任务自动并行
- 默认最大并行度: 4
- 自动计算时间节省

### 4. 错误处理

完善的错误处理机制：
- 任务失败时显示详细错误信息
- 支持可跳过任务（skippable）
- 集成错误自动修复系统

---

## 最佳实践

### 1. 清晰的目标描述

✅ **推荐**:
```bash
/plan 创建一个React项目，安装tailwindcss依赖，配置postcss，然后启动开发服务器
```

❌ **不推荐**:
```bash
/plan 搞个React项目
```

### 2. 合理的任务粒度

目标描述应该：
- 具体明确，包含关键步骤
- 避免过于抽象
- 不要过度细化（让LLM来分解）

### 3. 利用并行能力

对于可以并行的任务，系统会自动识别：
```bash
/plan 同时运行前端和后端的测试套件
```

### 4. 检查计划再执行

使用 `/tasks` 查看计划后再执行：
```bash
$ /plan 复杂的部署任务
$ /tasks  # 检查计划是否合理
$ /execute  # 确认后执行
```

---

## 故障排除

### 任务分解失败

**问题**: LLM 无法理解目标

**解决方案**:
- 使用更具体的描述
- 分解为更小的目标
- 检查 LLM 配置是否正确

### 执行失败

**问题**: 任务执行时出错

**解决方案**:
1. 使用 `/task_status` 查看详细错误
2. 检查命令权限
3. 确认依赖是否已安装
4. 调整任务计划重新执行

### 循环依赖

**问题**: 系统检测到循环依赖

**解决方案**:
- 重新描述目标，明确执行顺序
- 移除不必要的依赖关系
- 分解为多个独立的计划

---

## 性能调优

### 1. 并行度调整

系统默认最大并行度为 4，可以通过修改 `TaskPlanner` 配置调整。

### 2. 超时设置

默认任务超时为 300 秒（5分钟），可以通过 `TaskExecutor` 配置调整。

### 3. LLM 优化

- 使用快速的 LLM 模型（如 deepseek-chat）
- 配置合适的 max_subtasks 限制（默认20）

---

## 与其他功能集成

### 1. 错误自动修复

任务执行失败时，自动触发错误修复系统：
```bash
$ /execute
# 如果任务失败，系统会显示修复建议
```

### 2. 历史记录

所有任务执行都会记录到历史：
```bash
$ /history  # 查看执行历史
```

### 3. 统计分析

任务执行会被统计系统追踪：
```bash
$ /stats  # 查看统计信息
```

---

## 开发者文档

### 扩展任务类型

参考 `src/task/types.rs` 中的 `TaskType` 枚举。

### 自定义规划策略

参考 `src/task/planner.rs` 中的 `TaskPlanner` 实现。

### 添加新的分解模式

参考 `src/task/decomposer.rs` 中的提示词模板。

---

## 相关文档

- [Task System Architecture](../docs/01-understanding/design/task-system.md)
- [Task System Implementation](../docs/03-evolution/features/task-system.md)
- [Developer Guide](../docs/02-practice/developer/developer-guide.md)

---

**版本**: v1.0.0
**最后更新**: 2025-10-17
**作者**: RealConsole Contributors
